#!/usr/bin/env node
const { spawnSync } = require('child_process')
const args = (str) => str.split(' ')

const p = (proc) => {
  const { status } = proc
  if (status !== 0) {
    process.exit(status)
  }
}

spawnSync('docker', args('rm -f roach'), {
  stdio: 'inherit'
})

p(spawnSync('docker', args('run -d --name=roach --hostname=roach -p 26257:26257 -p 8080:8080 -v /tmp/cockroach-data:/cockroach/cockroach-data cockroachdb/cockroach:v20.1.2 start --insecure'), {
  stdio: 'inherit'
}))

spawnSync('docker', args('exec -it roach ./cockroach init --insecure'), {
  stdio: 'inherit'
})

let a = args('exec -it roach ./cockroach sql --insecure --execute')
a.push('CREATE USER IF NOT EXISTS mart;')
spawnSync('docker', a, {
  stdio: 'inherit'
})

a = args('exec -it roach ./cockroach sql --insecure --execute')
a.push('CREATE DATABASE IF NOT EXISTS mass;')
spawnSync('docker', a, {
  stdio: 'inherit'
})

a = args('exec -it roach ./cockroach sql --insecure --execute')
a.push('GRANT ALL ON DATABASE mass TO mart;')
spawnSync('docker', a, {
  stdio: 'inherit'
})
